{% extends 'app.html' %}

{% block title %}Hotspot Users{% endblock %}

{% block content %}
<style>
    /* Style for disabled users */
    .disabled-user {
        opacity: 0.5; /* Make the disabled user appear faded */
        pointer-events: none; /* Disable clicks and interactions */
    }

    /* Style for disabled user fields */
    .disabled-user td {
        color: #b0b0b0; /* Light gray text for disabled rows */
    }
</style>

<div class="container-xxl flex-grow-1 container-p-y">
    <h3 class="py-3 mb-4" align="center">Users for Hotspot Server under Router: <strong>{{ router.name }}</strong></h3>

    <div class="d-flex justify-content-end mb-3">
        <!--
        <div class="d-flex justify-content-end mb-3">
            <a href="{% url 'hotspots_users_create' router.id hotspotId %}" class="btn btn-primary">
                Create Single User
            </a>
        </div> &nbsp;&nbsp;&nbsp;&nbsp;
        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createMultipleUsersModal">Create Multiple Users</button>
        </div>
        -->
    </div>

    <!-- Hotspot Users Table -->
    <div class="card">
        <div class="table-responsive text-nowrap">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Vouchers</th>
                        <th>Package</th>
                        <th>Status</th>
                        <th>Uptime</th>
                        <th>Bytes In</th>
                        <th>Bytes Out</th>
                        <!--<th>Actions</th>-->
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr class="{% if user.disabled == 'true' %}disabled-user{% endif %}">
                            <td>{{ forloop.counter }}</td>
                            <td>{{ user.name }}</td>
                            <td>{{ user.profile|default:'N/A' }}</td>
                            <td>{% if user.disabled == 'false' %}Active{% else %}Disabled{% endif %}</td>
                            <td>{{ user.uptime|default:'N/A' }}</td>
                            <td>{{ user.bytes_in|default:0|floatformat:0 }}</td>
                            <td>{{ user.bytes_out|default:0|floatformat:0 }}</td>
                            <!--
                            <td class="text-center">
                                {% if user.disabled == 'false' %}
                                    <a href="{% url 'hotspots_users_edit' router.id hotspotId user.id %}" class="text-warning me-2">
                                        <i class="mdi mdi-pencil-outline"></i>
                                    </a>

                                    <form action="{% url 'hotspots_users_disable' router.id hotspotId user.id %}" method="POST" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="text-danger border-0 bg-transparent">
                                            <i class="mdi mdi-block-helper"></i>
                                        </button>
                                    </form>

                                    <form action="{% url 'hotspots_users_delete' router.id hotspotId user.id %}" method="POST" style="display:inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="_method" value="DELETE">
                                        <button type="submit" class="text-danger border-0 bg-transparent">
                                            <i class="mdi mdi-delete-outline"></i>
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="text-muted">User Disabled</span>
                                {% endif %}
                            </td>
                            -->
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">No users found</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="disableUserModal" tabindex="-1" aria-labelledby="disableUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="disableUserModalLabel">Confirm Disable</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="disableUserForm" method="POST" action="#">
                {% csrf_token %}
                <input type="hidden" name="_method" value="PATCH">
                <div class="modal-body">
                    Are you sure you want to disable this user?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Disable</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="deleteUserForm" method="POST" action="#">
                {% csrf_token %}
                <input type="hidden" name="_method" value="DELETE">
                <div class="modal-body">
                    Are you sure you want to delete this user? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for Creating Multiple Users -->
<div class="modal fade" id="createMultipleUsersModal" tabindex="-1" aria-labelledby="createMultipleUsersModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createMultipleUsersModalLabel">Create Multiple Hotspot Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="generatePdfForm" action="#" method="POST">
                {% csrf_token %}

                <!-- Hotspot Server Dropdown -->
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="hotspot_server" class="form-label">Hotspot Server</label>
                        <select name="hotspot_server" id="hotspot_server" class="form-control" required>
                            <option value="" disabled selected>Select a Hotspot Server</option>
                            {% for hotspot in hotspotServers %}
                                <option value="{{ hotspot.id }}">{{ hotspot.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Number of Users -->
                    <div class="mb-3">
                        <label for="number_of_users" class="form-label">Number of Users</label>
                        <input type="number" name="number_of_users" id="number_of_users" class="form-control" value="1" required>
                    </div>

                <!-- Profile Dropdown -->
                <div class="mb-3">
                    <label for="profile" class="form-label">Profile</label>
                    <select name="profile" id="profile" class="form-control" required>
            {% if profiles %}
                {% for profile in profiles %}
                    <option value="{{ profile.router_name|default:profile.name }}">{{ profile.display_name|default:profile.name|cut:'profile_' }}</option>
                {% endfor %}
                        {% else %}
                            <option value="" disabled>No profiles available</option>
                        {% endif %}
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Users and PDF</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle Disable Modal
        var disableUserModal = document.getElementById('disableUserModal');
        disableUserModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var userId = button.getAttribute('data-id');
            var form = document.getElementById('disableUserForm');
            form.action = '/routers/{{ router.id }}/hotspots/{{ hotspotId }}/users/' + userId + '/disable';
        });

        // Handle Delete Modal
        var deleteUserModal = document.getElementById('deleteUserModal');
        deleteUserModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var userId = button.getAttribute('data-id');
            var form = document.getElementById('deleteUserForm');
            form.action = '/routers/{{ router.id }}/hotspots/{{ hotspotId }}/users/' + userId;
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const hotspotSelect = document.getElementById('hotspot_server');
        const form = document.getElementById('generatePdfForm');

        hotspotSelect.addEventListener('change', function () {
            const hotspotId = hotspotSelect.value;
            const routerId = "{{ router.id }}";

            // Update the form action dynamically
            form.action = `/routers/${routerId}/hotspots/${hotspotId}/users/generate-pdf`;
        });
    });
</script>
{% endblock %}
